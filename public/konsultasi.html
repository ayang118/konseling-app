<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Konsultasi Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- GOOGLE FONT: INTER -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#4f46e5;
      --secondary:#6366f1;
      --soft:#eef2ff;
      --bg1:#f8fafc;
      --bg2:#eef2ff;
      --text:#111827;
      --muted:#6b7280;
      --white:#ffffff;
      --radius:18px;
    }

    *{
      box-sizing:border-box;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(circle at top left, #e0e7ff, transparent 40%),
        radial-gradient(circle at bottom right, #fbcfe8, transparent 40%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== BACK BUTTON ===== */
    .back-btn{
      position:fixed;
      top:22px;
      left:22px;
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 18px;
      background:rgba(255,255,255,.9);
      border:1px solid #e5e7eb;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      backdrop-filter:blur(10px);
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      transition:.25s;
      z-index:1000;
    }

    .back-btn:hover{
      transform:translateX(-4px);
      background:var(--white);
    }

    /* ===== WRAPPER ===== */
    .wrap{
      max-width:860px;
      margin:120px auto 80px;
      padding:0 20px;
      animation:fadeUp .8s ease;
    }

    @keyframes fadeUp{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:none}
    }

    /* ===== HEADER ===== */
    .title-box{
      margin-bottom:28px;
    }

    .title-box h2{
      margin:0;
      font-size:32px;
      font-weight:800;
      letter-spacing:-0.02em;
      color:#1e1b4b;
    }

    .subtitle{
      margin-top:10px;
      color:var(--muted);
      font-size:15px;
      max-width:560px;
      line-height:1.7;
    }

    /* ===== CARD ===== */
    .card{
      background:rgba(255,255,255,.88);
      border:1px solid #e5e7eb;
      border-radius:var(--radius);
      padding:30px;
      box-shadow:
        0 20px 40px rgba(0,0,0,.08),
        inset 0 1px 0 rgba(255,255,255,.4);
      backdrop-filter:blur(14px);
    }

    /* ===== GEJALA GRID ===== */
    .gejala-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:14px;
      margin-top:22px;
    }

    .gejala-item{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:15px 16px;
      border-radius:14px;
      background:var(--white);
      border:1px solid #e5e7eb;
      cursor:pointer;
      transition:.2s;
    }

    .gejala-item:hover{
      border-color:var(--secondary);
      background:var(--soft);
    }

    .gejala-item input{
      margin-top:4px;
      accent-color:var(--primary);
    }

    .gejala-item span{
      font-size:14px;
      line-height:1.6;
      font-weight:500;
    }

    /* ===== BUTTON ===== */
    .btn-primary{
      margin-top:26px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:white;
      border:none;
      padding:12px 28px;
      border-radius:999px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(79,70,229,.35);
      transition:.25s;
    }

    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 18px 40px rgba(79,70,229,.45);
    }

    /* ===== HASIL ===== */
    .hasil{
      margin-top:38px;
      animation:fadeUp .6s ease;
    }

    .hasil-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .confidence-badge{
      background:#ecfeff;
      color:#0369a1;
      padding:6px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }

    .diagnosis{
      font-size:22px;
      font-weight:800;
      margin:16px 0 8px;
      letter-spacing:-0.01em;
      color:#1e1b4b;
    }

    .diagnosis-desc{
      color:var(--muted);
      line-height:1.7;
      font-size:14px;
    }

    .tips-box{
      margin-top:20px;
      padding:18px;
      border-radius:14px;
      background:#f0f9ff;
      border:1px solid #bae6fd;
    }

    .tips-title{
      font-weight:600;
      margin-bottom:8px;
      color:#075985;
    }

    .tips-box li{
      font-size:14px;
      margin-bottom:6px;
      line-height:1.6;
    }

    hr{
      border:none;
      border-top:1px dashed #d1d5db;
      margin:24px 0;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>

<button class="back-btn" onclick="window.location.href='siswa-dashboard.html'">
  ‚Üê Dashboard
</button>

<div class="wrap">

  <div class="title-box">
    <h2>Konsultasi Mandiri</h2>
    <p class="subtitle">
      Luangkan sebentar untuk mengenali kondisi yang sedang kamu rasakan.
      Jawaban kamu membantu sistem memberikan rekomendasi awal yang paling relevan.
    </p>
  </div>

  <div class="card">
    <form id="formKonsultasi">
      <div id="gejalaList" class="gejala-grid">
        <p class="muted">Memuat data gejala...</p>
      </div>

      <button type="submit" class="btn-primary">
        üîç Proses Konsultasi
      </button>
    </form>

    <div id="hasilKonsultasi" class="hasil" style="display:none;"></div>
  </div>

</div>

<!-- SCRIPT LOGIC TETAP SAMA (TIDAK DIUBAH) -->
<script>
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user"));
  if (!token || !user) window.location.href="/login.html";

  async function loadGejala(){
    const box=document.getElementById("gejalaList");
    const res=await fetch("/api/gejala");
    const data=await res.json();
    box.innerHTML="";
    data.forEach(g=>{
      box.innerHTML+=`
        <label class="gejala-item">
          <input type="checkbox" value="${g.nama_gejala}">
          <span>${g.nama_gejala}</span>
        </label>`;
    });
  }
  loadGejala();

  async function simpanRiwayatKonsultasi(namaDiagnosis, gejalaDipilih){
    await fetch("/api/riwayat",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body:JSON.stringify({
        id_siswa:user.id,
        nama_siswa:user.nama,
        diagnosis:namaDiagnosis,
        gejala_json:gejalaDipilih
      })
    });
  }

  document.getElementById("formKonsultasi").addEventListener("submit",async e=>{
    e.preventDefault();
    const selected=[...document.querySelectorAll(".gejala-item input:checked")].map(el=>el.value);
    if(!selected.length)return alert("Pilih minimal satu gejala.");

    const hasil=document.getElementById("hasilKonsultasi");
    hasil.style.display="block";
    hasil.innerHTML="<p class='muted'>Memproses hasil konsultasi...</p>";

    const res=await fetch("/api/konsultasi",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body:JSON.stringify({gejala_dipilih:selected})
    });

    const data=await res.json();
    const h=data.hasil;

    simpanRiwayatKonsultasi(h.nama_diagnosis,selected);

    hasil.innerHTML=`
      <div class="hasil-header">
        <h3>üìä Hasil Diagnosis</h3>
        ${h.confidence?`<span class="confidence-badge">${h.confidence}% yakin</span>`:""}
      </div>
      <p class="diagnosis">${h.nama_diagnosis}</p>
      <p class="diagnosis-desc">${h.deskripsi}</p>
      ${h.tips?`
        <div class="tips-box">
          <p class="tips-title">Saran untuk kamu:</p>
          <ul>${h.tips.map(t=>`<li>${t}</li>`).join("")}</ul>
        </div>`:""}
      <hr>
      <p class="muted">Jika kondisi berlanjut, disarankan berkonsultasi langsung dengan Guru BK atau Psikolog.</p>
    `;
  });
</script>

</body>
</html>
